<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Down On Life">
    

    <!--Author-->
    
        <meta name="author" content="John Doe">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="进程间通信--管道"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Down On Life" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Color-Blind的笔记"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>进程间通信--管道 - Color-Blind的笔记</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2017/05/24/进程间通信-管道/">
                进程间通信--管道
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2017-05-24</span>
            
            <a href="#disqus_thread" class="comments">留言</a>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h2 id="进程间通信学习"><a href="#进程间通信学习" class="headerlink" title="进程间通信学习"></a>进程间通信学习</h2><a id="more"></a>
<p>进程间通信，是很多面试中都会问到的问题，以前只听过管道可以实现，但是对原理一无所知，<br>看到IBM文档中，有个不错的介绍(美中不足的是代码缩进的不好看)，所以，转载下来，以备不时之需:)</p>
<h4>管道的特点</h4>

<p>1.管道是半双工的，数据只能向一个方向流动；需要双方通信时，需要建立起两个管道；<br>2.只能用于父子进程或者兄弟进程之间（具有亲缘关系的进程）；<br>3.单独构成一种独立的文件系统：管道对于管道两端的进程而言，就是一个文件，但它不是普通的文件，它不属于某种文件系统，而是自立门户，单独构成一种文件系统，并且只存在与内存中。<br>4.数据的读出和写入：一个进程向管道中写的内容被管道另一端的进程读出。写入的内容每次都添加在管道缓冲区的末尾，并且每次都是从缓冲区的头部读出数据。</p>
<h4>管道的创建：</h4>


<p>一般使用如下代码创建管道:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe</span><span class="params">(<span class="keyword">int</span> fd[<span class="number">2</span>])</span></span>;</div><div class="line"></div></pre></td></tr></table></figure>
<h4>管道的读写规则</h4>

<p>管道两端可分别用描述字fd[0]以及fd[1]来描述，需要注意的是，管道的两端是固定了任务的。即一端只能用于读，由描述字fd[0]表示，称其为管道读端；<br>另一端则只能用于写，由描述字fd[1]来表示，称其为管道写端。<br>如果试图从管道写端读取数据，或者向管道读端写入数据都将导致错误发生。<br>很多系统调用，如read, write, close都可以用于管道操作。</p>
<h4>hello world</h4>

<p>pipe1.c如下，验证如何使用管道进行父子进程通信:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>]; <span class="comment">// 0为读管道，1为写管道</span></div><div class="line"></div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> read_buf[<span class="number">100</span>];</div><div class="line">    <span class="keyword">char</span> write_buf[<span class="number">4</span>];</div><div class="line"></div><div class="line">    <span class="keyword">int</span> read_num;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"pipe_fd error\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* 子进程 */</span></div><div class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">        <span class="comment">// 关闭写管道</span></div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        sleep(<span class="number">3</span>); <span class="comment">// 确保父进程关闭写端</span></div><div class="line">        <span class="comment">// 从读管道读数据</span></div><div class="line">        read_num = read(pipe_fd[<span class="number">0</span>], read_buf, <span class="number">100</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"read num is %d the data read from the pipe %s\n"</span>, read_num, read_buf);</div><div class="line">        <span class="comment">// 关闭读管道</span></div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 关闭读管道</span></div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="built_in">strcpy</span>(write_buf, <span class="string">"111"</span>);</div><div class="line">        <span class="keyword">if</span> (write(pipe_fd[<span class="number">1</span>], write_buf, <span class="number">4</span>) != <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to child over!\n"</span>);</div><div class="line">            <span class="comment">// 关闭写管道</span></div><div class="line">            close(pipe_fd[<span class="number">1</span>]);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"parent close write pipe: pipe_fd[1] over!\n"</span>);</div><div class="line">            sleep(<span class="number">10</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">write to child over!</div><div class="line">parent close write pipe: pipe_fd[1] over!</div><div class="line"></div><div class="line">read num is 4 the data read from the pipe 111</div><div class="line"></div></pre></td></tr></table></figure>
<p>说明使用管道，确实可以让父子进程通信数据。</p>
<h4>向管道写数据规则</h4>

<p>向管道中写入数据时，Linux将不保证写入的原子性，管道缓冲区一有空闲区域，写进程就会试图向管道写入数据。如果读进程不读走管道缓冲区中的数据，那么写操作将一直阻塞。 </p>
<p>注：只有在管道的读端存在时，向管道中写入数据才有意义。否则，向管道中写入数据的进程将收到内核传来的SIFPIPE信号，应用程序可以处理该信号，也可以忽略（默认动作则是应用程序终止）。</p>
<p>write.c如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> read_buf[<span class="number">4</span>];</div><div class="line">    <span class="keyword">char</span> *write_buf;</div><div class="line">    <span class="keyword">int</span> write_num;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"pipe_fd error\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   </div><div class="line">    <span class="keyword">if</span> ((pid=fork()) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I'm Child, My PID is %ld, my Parent is %ld\n"</span>, (<span class="keyword">long</span>)getpid(), (<span class="keyword">long</span>)getppid());</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I'm Parent, My PID is %ld, my Parent is %ld\n"</span>, (<span class="keyword">long</span>)getpid(), (<span class="keyword">long</span>)getppid());</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        close(pipe_fd[<span class="number">0</span>]); </div><div class="line">        write_buf = <span class="string">"111"</span>;</div><div class="line">        <span class="comment">// 此处会触发 Program received signal SIGPIPE, Broken pipe. 程序会终止</span></div><div class="line">        write_num = write(pipe_fd[<span class="number">1</span>], write_buf, <span class="number">4</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (write_num == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to pipe error\n"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"the bytes write to pipe is %d \n"</span>, write_num);</div><div class="line">        &#125;</div><div class="line">        close(pipe_fd[<span class="number">1</span>]); </div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>这个程序并不能运行完，也就是无法输出write to pipe error或者the bytes write to pipe is xxx<br>因为，在写之前，就关闭了读管道，所以，写就变得没有意义了:</p>
<blockquote>
<p>On a last note, pipes must have a reader and a writer. If a process tries to write to a pipe that has no reader, it will be sent the SIGPIPE signal from the kernel. </p>
</blockquote>
<p>如果进程尝试写入一个没有读的管道，会从内核收到SIGPIPE信号，默认情况下，会终止进程，所以，这个程序无法输出<br>write to pipe error或者the bytes write to pipe is xxx</p>
<p>Broken pipe,原因就是该管道以及它的所有fork()<br>产物的读端都已经被关闭。如果在父进程中保留读端，即在写完pipe后，再关闭父进程的读端，也会正常写入pipe。<br>比如下面的例子，就能写入了</p>
<p>close_after_write.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> read_buf[<span class="number">4</span>];</div><div class="line">    <span class="keyword">char</span> *write_buf;</div><div class="line">    <span class="keyword">int</span> write_num;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"pipe_fd error\n"</span>);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">   </div><div class="line">    <span class="keyword">if</span> ((pid=fork()) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I'm Child, My PID is %ld, my Parent is %ld\n"</span>, (<span class="keyword">long</span>)getpid(), (<span class="keyword">long</span>)getppid());</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"I'm Parent, My PID is %ld, my Parent is %ld\n"</span>, (<span class="keyword">long</span>)getpid(), (<span class="keyword">long</span>)getppid());</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">         </div><div class="line">        write_buf = <span class="string">"111"</span>;</div><div class="line">        <span class="comment">// 有一端保留读写管道，依然可以写入</span></div><div class="line">        write_num = write(pipe_fd[<span class="number">1</span>], write_buf, <span class="number">4</span>);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (write_num == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to pipe error\n"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"the bytes write to pipe is %d \n"</span>, write_num);</div><div class="line">        &#125;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]); </div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>Linux不保证写管道的原子性</p>
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> r_buf[<span class="number">4096</span>];</div><div class="line">    <span class="keyword">char</span> w_buf[<span class="number">4096</span> * <span class="number">2</span>];</div><div class="line">    <span class="keyword">int</span> writenum;</div><div class="line">    <span class="keyword">int</span> rnum;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"pipe error \n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="comment">// 子进程一直读</span></div><div class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">            sleep(<span class="number">1</span>);</div><div class="line">            rnum = read(pipe_fd[<span class="number">0</span>], r_buf, <span class="number">1000</span>);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"child: readnum is %d\n"</span>, rnum);</div><div class="line">        &#125;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="comment">// 父进程去写</span></div><div class="line">        <span class="keyword">if</span>((writenum = write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">1024</span>)) == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to pipe error\n"</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"the bytes write to pipe is %d \n"</span>, writenum);</div><div class="line">        &#125;</div><div class="line">        writenum = write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">4096</span>);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">the bytes write to pipe 1000</div><div class="line">the bytes write to pipe 1000  //注意，此行输出说明了写入的非原子性</div><div class="line">the bytes write to pipe 1000</div><div class="line">the bytes write to pipe 1000</div><div class="line">the bytes write to pipe 1000</div><div class="line">the bytes write to pipe 120  //注意，此行输出说明了写入的非原子性</div><div class="line">the bytes write to pipe 0</div><div class="line">the bytes write to pipe 0</div><div class="line">...</div><div class="line"></div></pre></td></tr></table></figure>
<blockquote>
<p>In order for an operation to be considered ``atomic’’, it must not be interrupted for any reason at all. The entire operation occurs at once. </p>
</blockquote>
<p>如果一个操作是原子性的，他必须不能被任何原因中断。整个操作离开发生。</p>
<blockquote>
<p>Up to 512 bytes can be written or retrieved from a pipe atomically. Anything that crosses this threshold will be split, and not atomic. Under Linux, however, the atomic operational limit is defined in ``linux/limits.h’’ as:</p>
</blockquote>
<p>超过512字节会被管道原子地写入或者取回。任何数据通过这个入口的都会被分割，不是原子性地。在Linux下，原子操作的<br>限制在linux/limits.h中定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PIPE_BUF        4096</span></div></pre></td></tr></table></figure>
<blockquote>
<p>As you can see, Linux accommodates the minimum number of bytes required by POSIX,<br>quite considerably I might add. The atomicity of a pipe operation becomes important when more than one process is involved (FIFOS).<br>For example, if the number of bytes written to a pipe exceeds the atomic limit for a single operation,<br>and multiple processes are writing to the pipe, the data will be <code>interleaved&#39;&#39; or</code>chunked’’.<br>In other words, one process may insert data into the pipeline between the writes of another.</p>
</blockquote>
<p>总之，一个进程可以在另外一个进程在写管道时候同时写管道，而不必等管道的缓存区为空时候才能写。</p>
<p>写入管道的数据量大于4096字节时，缓冲区的空闲空间将被写入数据（补齐），直到写完所有数据为止，如果没有进程读数据，则一直阻塞<br>如果超过4096个字节时，那么操作将变为原子的，比如以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> r_buf[<span class="number">4096</span>];</div><div class="line">    <span class="keyword">char</span> w_buf[<span class="number">4096</span> * <span class="number">2</span>];</div><div class="line">    <span class="keyword">int</span> writenum;</div><div class="line">    <span class="keyword">int</span> rnum;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"pipe error \n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="comment">// 子进程一直读</span></div><div class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">            sleep(<span class="number">1</span>);</div><div class="line">            rnum = read(pipe_fd[<span class="number">0</span>], r_buf, <span class="number">1000</span>);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"child: readnum is %d\n"</span>, rnum);</div><div class="line">        &#125;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="comment">// 父进程去写</span></div><div class="line">        <span class="keyword">if</span>((writenum = write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">5000</span>)) == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to pipe error\n"</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"the bytes write to pipe is %d \n"</span>, writenum);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">30</span>; i++) &#123;</div><div class="line">            sleep(<span class="number">1</span>);</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</div><div class="line">        &#125;</div><div class="line">        writenum = write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">5000</span>);</div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>这里，数据量大于4096字节（5000），缓冲区的空闲空间将被写入数据，读进程读完了5000个以后，就不再读了，而是<br>等待写进程继续写，如果没有写，则会一直阻塞住。</p>
<h4>管道应用实例</h4>

<p>1.shell中的管道，比如输入输出重定向，这个命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pgrep -f a.out | xargs kill</div></pre></td></tr></table></figure>
<p>将 pgrep 的输出作为 kill的输入，在这种应用方式下，管道的创建对于用户来说是透明的。</p>
<p>2.用于具有亲缘关系的进程间通信</p>
<p>比如，尝试编写一个然并卵的例子，父进程发送一个数字，子进程把这个数字乘以2：</p>
<p>double.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> pipe_fd[<span class="number">2</span>];</div><div class="line">    <span class="keyword">pid_t</span> pid;</div><div class="line">    <span class="keyword">char</span> r_buf[<span class="number">3</span>];</div><div class="line">    <span class="keyword">char</span> w_buf[<span class="number">3</span>] = <span class="string">"41"</span>;</div><div class="line">    <span class="keyword">int</span> writenum;</div><div class="line">    <span class="keyword">int</span> rnum;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (pipe(pipe_fd) &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"pipe error \n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">        close(pipe_fd[<span class="number">1</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((rnum = read(pipe_fd[<span class="number">0</span>], r_buf, <span class="number">3</span>)) &lt; <span class="number">0</span> ) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"error read \n"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"get num is %d, add one is %d\n"</span>, atoi(r_buf), atoi(r_buf) + <span class="number">1</span>);</div><div class="line">        </div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</div><div class="line">        close(pipe_fd[<span class="number">0</span>]);</div><div class="line">        <span class="comment">// 父进程去写</span></div><div class="line">        <span class="keyword">if</span>((writenum = write(pipe_fd[<span class="number">1</span>], w_buf, <span class="number">3</span>)) == <span class="number">-1</span>) &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"write to pipe error\n"</span>);</div><div class="line">        &#125;<span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"the bytes write to pipe is %d \n"</span>, writenum);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<h4>管道的局限性</h4>

<p>1.只支持单向数据流；<br>2.只能用于具有亲缘关系的进程之间；<br>3.没有名字；<br>4.管道的缓冲区是有限的（管道制存在于内存中，在管道创建时，为缓冲区分配一个页面大小）；<br>5.管道所传送的是无格式字节流，这就要求管道的读出方和写入方必须事先约定好数据的格式，比如多少字节算作一个消息（或命令、或记录）等等；</p>
<h4>有名管道</h4>

<p>管道应用的一个重大限制是它没有名字，因此，只能用于具有亲缘关系的进程间通信，在有名管道（named pipe或FIFO）提出后，该限制得到了克服。<br>FIFO不同于管道之处在于它提供一个路径名与之关联，以FIFO的文件形式存在于文件系统中。<br>这样，即使与FIFO的创建进程不存在亲缘关系的进程，只要可以访问该路径，就能够彼此通过FIFO相互通信（能够访问该路径的进程以及FIFO的创建进程之间），因此，通过FIFO不相关的进程也能交换数据。<br>值得注意的是，FIFO严格遵循先进先出（first in first out），对管道及FIFO的读总是从开始处返回数据，对它们的写则把数据添加到末尾。<br>它们不支持诸如lseek()等文件定位操作。</p>
<p>简单的说，就是建立一个公共缓存区，只有能读到这片区域的进程，都可以利用这片区域进行通信了。</p>
<h4>有名管道的创建</h4>

<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">mkfifo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * pathname, <span class="keyword">mode_t</span> mode)</span></span></div></pre></td></tr></table></figure>
<p>该函数的第一个参数是一个普通的路径名，也就是创建后FIFO的名字。<br>第二个参数与打开普通文件的open()函数中的mode 参数相同。<br>如果mkfifo的第一个参数是一个已经存在的路径名时，会返回EEXIST错误，所以一般典型的调用代码首先会检查是否返回该错误，如果确实返回该错误，那么只要调用打开FIFO的函数就可以了。</p>
<p>创建实例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FIFO_SERVER <span class="meta-string">"/tmp/mybuff"</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</div><div class="line">    res = mkfifo(FIFO_SERVER, O_CREAT | O_EXCL );</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"mkfifo res is %d\n"</span>, res);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div></pre></td></tr></table></figure>
<p>查看建立的文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">file /tmp/mybuff</div><div class="line">/tmp/mybuff: setuid sticky fifo (named pipe)</div></pre></td></tr></table></figure>
<h4>有名管道的打开规则</h4>

<p>名管道比管道多了一个打开操作：open 比无名管道要复杂啊。。。</p>
<p>如果当前打开操作是为读而打开FIFO时，<br>  若已经有相应进程为写而打开该FIFO，则当前打开操作将成功返回；<br>  否则，可能阻塞直到有相应进程为写而打开该FIFO（当前打开操作设置了阻塞标志）；<br>  或者，成功返回（当前打开操作没有设置阻塞标志）。</p>
<p>如果当前打开操作是为写而打开FIFO时，<br>  若已经有相应进程为读而打开该FIFO，则当前打开操作将成功返回；<br>  否则，可能阻塞直到有相应进程为读而打开该FIFO（当前打开操作设置了阻塞标志）；<br>  或者，返回ENXIO错误（当前打开操作没有设置阻塞标志）。</p>
<h4>有名管道的读写规则</h4>

<p>从FIFO中读取数据：</p>
<p>约定：如果一个进程为了从FIFO中读取数据而阻塞打开FIFO，那么称该进程内的读操作为设置了阻塞标志的读操作。</p>
<p>1.如果有进程写打开FIFO，且当前FIFO内没有数据，则对于设置了阻塞标志的读操作来说，将一直阻塞。对于没有设置阻塞标志读操作来说则返回-1，当前errno值为EAGAIN，提醒以后再试。</p>
<p>2.对于设置了阻塞标志的读操作说，造成阻塞的原因有两种：当前FIFO内有数据，但有其它进程在读这些数据；另外就是FIFO内没有数据。解阻塞的原因则是FIFO中有新的数据写入，不论信写入数据量的大小，也不论读操作请求多少数据量。</p>
<p>3.读打开的阻塞标志只对本进程第一个读操作施加作用，如果本进程内有多个读操作序列，则在第一个读操作被唤醒并完成读操作后，其它将要执行的读操作将不再阻塞，即使在执行读操作时，FIFO中没有数据也一样（此时，读操作返回0）</p>
<p>4.如果没有进程写打开FIFO，则设置了阻塞标志的读操作会阻塞。</p>
<p>注：如果FIFO中有数据，则设置了阻塞标志的读操作不会因为FIFO中的字节数小于请求读的字节数而阻塞，此时，读操作会返回FIFO中现有的数据量。</p>
<p>向FIFO中写入数据：</p>
<p>约定：如果一个进程为了向FIFO中写入数据而阻塞打开FIFO，那么称该进程内的写操作为设置了阻塞标志的写操作。</p>
<p>对于设置了阻塞标志的写操作：</p>
<p>1.当要写入的数据量不大于PIPE_BUF时，linux将保证写入的原子性。如果此时管道空闲缓冲区不足以容纳要写入的字节数，则进入睡眠，直到当缓冲区中能够容纳要写入的字节数时，才开始进行一次性写操作。</p>
<ol>
<li>当要写入的数据量大于PIPE_BUF时，linux将不再保证写入的原子性。FIFO缓冲区一有空闲区域，写进程就会试图向管道写入数据，写操作在写完所有请求写的数据后返回。</li>
</ol>
<p>对于没有设置阻塞标志的写操作：</p>
<p>1.当要写入的数据量大于PIPE_BUF时，linux将不再保证写入的原子性。在写满所有FIFO空闲缓冲区后，写操作返回。</p>
<p>2.当要写入的数据量不大于PIPE_BUF时，linux将保证写入的原子性。如果当前FIFO空闲缓冲区能够容纳请求写入的字节数，写完后成功返回；如果当前FIFO空闲缓冲区不能够容纳请求写入的字节数，则返回EAGAIN错误，提醒以后再写；</p>
<p>实际使用时，需要针对不同的场景，使用不同的方式。具体就不写实例了，因为太多种组合。。。</p>
<h4>小结</h4>

<p>FIFO可以说是管道的推广，克服了管道无名字的限制，使得无亲缘关系的进程同样可以采用先进先出的通信机制进行通信。<br>管道和FIFO的数据是字节流，应用程序之间必须事先确定特定的传输”协议”，采用传播具有特定意义的消息。<br>要灵活应用管道及FIFO，理解它们的读写规则是关键。</p>
<p>参考：<br>1.<a href="https://www.ibm.com/developerworks/cn/linux/l-ipc/part1/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-ipc/part1/</a><br>2.<a href="http://www.tldp.org/LDP/lpg/node20.html" target="_blank" rel="external">http://www.tldp.org/LDP/lpg/node20.html</a><br>3.<a href="http://www.tldp.org/LDP/lpg/node13.html" target="_blank" rel="external">http://www.tldp.org/LDP/lpg/node13.html</a></p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/Linux/">#Linux</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    主题由 <a href="https://github.com/klugjo">Jonathan Klughertz</a> 开发设计
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2017/05/24/进程间通信-管道/">进程间通信--管道</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/05/16/Python-list-comprehension-和-append/">Python list comprehension</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/05/16/Python-all-用法/">Python __all__用法</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/05/15/MySQL-Unknown-table-engine-InnoDb-错误解决/">MySQL Unknown table engin</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    由 Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a> 强力驱动
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>